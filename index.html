<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–¢–†–û–ô–ë–ê–¢ –ö–∞—Ç–∞–ª–æ–≥ - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-button-color: #3B82F6;
            --tg-theme-button-text-color: #ffffff;
        }
        
        .tg-theme-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        
        .tg-theme-text {
            color: var(--tg-theme-text-color);
        }
        
        .tg-theme-hint {
            color: var(--tg-theme-hint-color);
        }
        
        .tg-theme-secondary-bg {
            background-color: var(--tg-theme-secondary-bg-color);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-md mx-auto">
        <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button id="toggleMenu" class="p-2 rounded-lg tg-theme-secondary-bg">
                    <i data-feather="menu"></i>
                </button>
                <h1 class="text-lg font-semibold tg-theme-text">–ö–∞—Ç–∞–ª–æ–≥ - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
                <button onclick="toggleDebug()" class="p-2 rounded-lg tg-theme-secondary-bg">
                    <i data-feather="terminal"></i>
                </button>
            </div>
        </header>

        <!-- Debug Info -->
        <div id="debugInfo" class="p-4 bg-yellow-50 border border-yellow-200 text-xs">
            <h4 class="font-semibold mb-2">–†–µ–∂–∏–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω:</h4>
            <pre id="debugContent"></pre>
        </div>

        <!-- Main Content -->
        <main id="content" class="p-4">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-4">
                <h2 class="text-xl font-bold mb-4">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API</h2>
                
                <div class="space-y-4">
                    <button onclick="testAllEndpoints()" class="w-full py-3 tg-theme-button rounded-lg font-medium">
                        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
                    </button>
                    
                    <button onclick="loadSections()" class="w-full py-3 bg-blue-100 text-blue-700 rounded-lg font-medium">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã
                    </button>
                    
                    <button onclick="loadAllProducts()" class="w-full py-3 bg-green-100 text-green-700 rounded-lg font-medium">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
                    </button>
                    
                    <button onclick="analyzeDataStructure()" class="w-full py-3 bg-purple-100 text-purple-700 rounded-lg font-medium">
                        –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                    </button>
                </div>
            </div>
            
            <div id="results" class="space-y-4"></div>
        </main>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        const API_BASE = 'https://dmitrii2613.pythonanywhere.com/api';
        
        const content = document.getElementById('content');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        const results = document.getElementById('results');

        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            
            debugContent.textContent += logMessage + '\n\n';
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function toggleDebug() {
            // –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏
        }

        async function apiFetch(endpoint) {
            try {
                debugLog(`üîç –ó–∞–ø—Ä–æ—Å: ${endpoint}`);
                const response = await fetch(`${API_BASE}${endpoint}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debugLog(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${endpoint}`, data);
                return data;
            } catch (error) {
                debugLog(`‚ùå –û—à–∏–±–∫–∞: ${endpoint}`, { error: error.message });
                return null;
            }
        }

        async function testAllEndpoints() {
            results.innerHTML = '<div class="text-center py-4">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';
            
            const endpoints = [
                '/sections',
                '/all_products',
                '/categories/1', // —Ç–µ—Å—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º ID
                '/models/1/1',   // —Ç–µ—Å—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ ID
                '/submodels/1/1/1' // —Ç–µ—Å—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ ID
            ];

            let html = '<div class="space-y-4">';
            
            for (const endpoint of endpoints) {
                html += `<div class="bg-white rounded-lg p-4 border">
                    <h3 class="font-semibold mb-2">${endpoint}</h3>
                    <div id="result-${endpoint.replace(/\//g, '-')}">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>`;
            }
            
            html += '</div>';
            results.innerHTML = html;

            // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
            for (const endpoint of endpoints) {
                const data = await apiFetch(endpoint);
                const resultDiv = document.getElementById(`result-${endpoint.replace(/\//g, '-')}`);
                
                if (data) {
                    const count = Object.values(data)[0]?.length || 0;
                    resultDiv.innerHTML = `
                        <div class="text-green-600 font-semibold">‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${count}</div>
                        <div class="text-xs mt-2">${JSON.stringify(data).substring(0, 200)}...</div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="text-red-600 font-semibold">‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                }
            }
        }

        async function loadSections() {
            debugLog('=== –ó–ê–ì–†–£–ó–ö–ê –†–ê–ó–î–ï–õ–û–í ===');
            const data = await apiFetch('/sections');
            
            if (!data || !data.sections) {
                results.innerHTML = '<div class="text-red-600">‚ùå –†–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">–ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${data.sections.length}</h3>
                <div class="space-y-2">`;
            
            data.sections.forEach(section => {
                html += `
                    <div class="p-3 border rounded">
                        <div class="font-medium">${section.name}</div>
                        <div class="text-sm text-gray-600">ID: ${section.id}</div>
                        <button onclick="testCategories('${section.id}', '${section.name}')" 
                                class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            –¢–µ—Å—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        </button>
                    </div>
                `;
            });
            
            html += '</div></div>';
            results.innerHTML = html;
        }

        async function testCategories(sectionId, sectionName) {
            debugLog(`=== –¢–ï–°–¢ –ö–ê–¢–ï–ì–û–†–ò–ô –î–õ–Ø –†–ê–ó–î–ï–õ–ê ${sectionName} ===`);
            const data = await apiFetch(`/categories/${sectionId}`);
            
            if (!data || !data.categories || data.categories.length === 0) {
                results.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 p-4 rounded">
                        <h3 class="font-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "${sectionName}"</h3>
                        <p class="text-sm mt-2">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã –Ω–∞–ø—Ä—è–º—É—é...</p>
                        <button onclick="findProductsBySection('${sectionId}', '${sectionName}')" 
                                class="mt-2 px-3 py-1 bg-green-500 text-white rounded text-sm">
                            –ò—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                        </button>
                    </div>
                `;
                return;
            }

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è "${sectionName}": ${data.categories.length}</h3>
                <div class="space-y-2">`;
            
            data.categories.forEach(category => {
                html += `
                    <div class="p-3 border rounded">
                        <div class="font-medium">${category.name}</div>
                        <div class="text-sm text-gray-600">ID: ${category.id}</div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="testModels('${sectionId}', '${sectionName}', '${category.id}', '${category.name}')" 
                                    class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                                –¢–µ—Å—Ç –º–æ–¥–µ–ª–∏
                            </button>
                            <button onclick="findProductsByCategory('${sectionId}', '${sectionName}', '${category.id}', '${category.name}')" 
                                    class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                –ò—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            results.innerHTML = html;
        }

        async function testModels(sectionId, sectionName, categoryId, categoryName) {
            debugLog(`=== –¢–ï–°–¢ –ú–û–î–ï–õ–ï–ô –î–õ–Ø –ö–ê–¢–ï–ì–û–†–ò–ò ${categoryName} ===`);
            const data = await apiFetch(`/models/${sectionId}/${categoryId}`);
            
            if (!data || !data.models || data.models.length === 0) {
                results.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 p-4 rounded">
                        <h3 class="font-semibold">–ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"</h3>
                        <p class="text-sm mt-2">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–º–æ–¥–µ–ª–∏...</p>
                        <button onclick="testSubmodels('${sectionId}', '${sectionName}', '${categoryId}', '${category.name}', 'null')" 
                                class="mt-2 px-3 py-1 bg-purple-500 text-white rounded text-sm">
                            –¢–µ—Å—Ç –ø–æ–¥–º–æ–¥–µ–ª–∏
                        </button>
                    </div>
                `;
                return;
            }

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">–ú–æ–¥–µ–ª–∏ –¥–ª—è "${categoryName}": ${data.models.length}</h3>
                <div class="space-y-2">`;
            
            data.models.forEach(model => {
                html += `
                    <div class="p-3 border rounded">
                        <div class="font-medium">${model.name}</div>
                        <div class="text-sm text-gray-600">ID: ${model.id}</div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="testSubmodels('${sectionId}', '${sectionName}', '${categoryId}', '${categoryName}', '${model.id}', '${model.name}')" 
                                    class="px-3 py-1 bg-purple-500 text-white rounded text-sm">
                                –¢–µ—Å—Ç –ø–æ–¥–º–æ–¥–µ–ª–∏
                            </button>
                            <button onclick="findProductsByModel('${sectionId}', '${sectionName}', '${categoryId}', '${categoryName}', '${model.id}', '${model.name}')" 
                                    class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                –ò—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            results.innerHTML = html;
        }

        async function testSubmodels(sectionId, sectionName, categoryId, categoryName, modelId, modelName = '') {
            debugLog(`=== –¢–ï–°–¢ –ü–û–î–ú–û–î–ï–õ–ï–ô ===`);
            const data = await apiFetch(`/submodels/${sectionId}/${categoryId}/${modelId}`);
            
            if (!data || !data.submodels || data.submodels.length === 0) {
                results.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 p-4 rounded">
                        <h3 class="font-semibold">–ü–æ–¥–º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p class="text-sm mt-2">–ú–æ–¥–µ–ª—å: ${modelName || '–ë–µ–∑ –º–æ–¥–µ–ª–∏'}</p>
                        <button onclick="findProductsByModel('${sectionId}', '${sectionName}', '${categoryId}', '${categoryName}', '${modelId}', '${modelName}')" 
                                class="mt-2 px-3 py-1 bg-green-500 text-white rounded text-sm">
                            –ò—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                        </button>
                    </div>
                `;
                return;
            }

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">–ü–æ–¥–º–æ–¥–µ–ª–∏: ${data.submodels.length}</h3>
                <div class="space-y-2">`;
            
            data.submodels.forEach(submodel => {
                html += `
                    <div class="p-3 border rounded">
                        <div class="font-medium">${submodel.name}</div>
                        <div class="text-sm text-gray-600">ID: ${submodel.id}</div>
                        <button onclick="findProductsBySubmodel('${sectionId}', '${sectionName}', '${categoryId}', '${categoryName}', '${modelId}', '${modelName}', '${submodel.id}', '${submodel.name}')" 
                                class="mt-2 px-3 py-1 bg-green-500 text-white rounded text-sm">
                            –ò—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                        </button>
                    </div>
                `;
            });
            
            html += '</div></div>';
            results.innerHTML = html;
        }

        async function loadAllProducts() {
            debugLog('=== –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –¢–û–í–ê–†–û–í ===');
            const data = await apiFetch('/all_products');
            
            if (!data || !data.products) {
                results.innerHTML = '<div class="text-red-600">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–æ–≤–∞—Ä–æ–≤
            const products = data.products;
            const withSection = products.filter(p => p.section_id).length;
            const withCategory = products.filter(p => p.category_id).length;
            const withModel = products.filter(p => p.model_id).length;
            const withSubmodel = products.filter(p => p.submodel_id).length;

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">–í—Å–µ —Ç–æ–≤–∞—Ä—ã: ${products.length}</h3>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div class="bg-blue-50 p-2 rounded">–° —Ä–∞–∑–¥–µ–ª–æ–º: ${withSection}</div>
                    <div class="bg-green-50 p-2 rounded">–° –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π: ${withCategory}</div>
                    <div class="bg-yellow-50 p-2 rounded">–° –º–æ–¥–µ–ª—å—é: ${withModel}</div>
                    <div class="bg-purple-50 p-2 rounded">–° –ø–æ–¥–º–æ–¥–µ–ª—å—é: ${withSubmodel}</div>
                </div>
                <div class="text-xs max-h-60 overflow-y-auto">
                    <pre>${JSON.stringify(products.slice(0, 5), null, 2)}</pre>
                </div>
            </div>`;
            
            results.innerHTML = html;
        }

        async function findProductsBySection(sectionId, sectionName) {
            debugLog(`=== –ü–û–ò–°–ö –¢–û–í–ê–†–û–í –î–õ–Ø –†–ê–ó–î–ï–õ–ê ${sectionName} ===`);
            const data = await apiFetch('/all_products');
            
            if (!data || !data.products) {
                results.innerHTML = '<div class="text-red-600">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const filtered = data.products.filter(p => p.section_id == sectionId);
            showProductResults(filtered, `–¢–æ–≤–∞—Ä—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "${sectionName}"`);
        }

        async function findProductsByCategory(sectionId, sectionName, categoryId, categoryName) {
            debugLog(`=== –ü–û–ò–°–ö –¢–û–í–ê–†–û–í –î–õ–Ø –ö–ê–¢–ï–ì–û–†–ò–ò ${categoryName} ===`);
            const data = await apiFetch('/all_products');
            
            if (!data || !data.products) {
                results.innerHTML = '<div class="text-red-600">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const filtered = data.products.filter(p => 
                p.section_id == sectionId && p.category_id == categoryId
            );
            showProductResults(filtered, `–¢–æ–≤–∞—Ä—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"`);
        }

        async function findProductsByModel(sectionId, sectionName, categoryId, categoryName, modelId, modelName) {
            debugLog(`=== –ü–û–ò–°–ö –¢–û–í–ê–†–û–í –î–õ–Ø –ú–û–î–ï–õ–ò ${modelName} ===`);
            const data = await apiFetch('/all_products');
            
            if (!data || !data.products) {
                results.innerHTML = '<div class="text-red-600">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const filtered = data.products.filter(p => 
                p.section_id == sectionId && 
                p.category_id == categoryId && 
                p.model_id == modelId
            );
            showProductResults(filtered, `–¢–æ–≤–∞—Ä—ã –¥–ª—è –º–æ–¥–µ–ª–∏ "${modelName}"`);
        }

        async function findProductsBySubmodel(sectionId, sectionName, categoryId, categoryName, modelId, modelName, submodelId, submodelName) {
            debugLog(`=== –ü–û–ò–°–ö –¢–û–í–ê–†–û–í –î–õ–Ø –ü–û–î–ú–û–î–ï–õ–ò ${submodelName} ===`);
            const data = await apiFetch('/all_products');
            
            if (!data || !data.products) {
                results.innerHTML = '<div class="text-red-600">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const filtered = data.products.filter(p => 
                p.section_id == sectionId && 
                p.category_id == categoryId && 
                p.model_id == modelId &&
                p.submodel_id == submodelId
            );
            showProductResults(filtered, `–¢–æ–≤–∞—Ä—ã –¥–ª—è –ø–æ–¥–º–æ–¥–µ–ª–∏ "${submodelName}"`);
        }

        function showProductResults(products, title) {
            if (products.length === 0) {
                results.innerHTML = `
                    <div class="bg-red-100 border border-red-400 p-4 rounded">
                        <h3 class="font-semibold">‚ùå ${title}</h3>
                        <p class="mt-2">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }

            let html = `<div class="bg-white rounded-lg p-4">
                <h3 class="font-semibold mb-4">‚úÖ ${title}: ${products.length} —Ç–æ–≤–∞—Ä–æ–≤</h3>
                <div class="space-y-3">`;
            
            products.forEach(product => {
                html += `
                    <div class="p-3 border rounded">
                        <div class="font-medium">${product.name || product.color || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                        <div class="text-sm text-gray-600">
                            ID: ${product.id}<br>
                            –†–∞–∑–¥–µ–ª: ${product.section_id} | –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${product.category_id}<br>
                            –ú–æ–¥–µ–ª—å: ${product.model_id} | –ü–æ–¥–º–æ–¥–µ–ª—å: ${product.submodel_id}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            results.innerHTML = html;
        }

        async function analyzeDataStructure() {
            debugLog('=== –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–• ===');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            const [sectionsData, productsData] = await Promise.all([
                apiFetch('/sections'),
                apiFetch('/all_products')
            ]);

            if (!sectionsData || !productsData) {
                results.innerHTML = '<div class="text-red-600">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';
                return;
            }

            const sections = sectionsData.sections || [];
            const products = productsData.products || [];

            let analysis = '';

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–≤—è–∑–∏
            sections.forEach(section => {
                const sectionProducts = products.filter(p => p.section_id == section.id);
                const sectionCategories = [...new Set(sectionProducts.map(p => p.category_id).filter(Boolean))];
                
                analysis += `
–†–∞–∑–¥–µ–ª: ${section.name} (ID: ${section.id})
- –¢–æ–≤–∞—Ä–æ–≤: ${sectionProducts.length}
- –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${sectionCategories.length}
`;

                sectionCategories.forEach(catId => {
                    const catProducts = sectionProducts.filter(p => p.category_id == catId);
                    const catModels = [...new Set(catProducts.map(p => p.model_id).filter(Boolean))];
                    
                    analysis += `  ‚îî‚îÄ –ö–∞—Ç–µ–≥–æ—Ä–∏—è ID: ${catId}\n`;
                    analysis += `     ‚îú‚îÄ –¢–æ–≤–∞—Ä–æ–≤: ${catProducts.length}\n`;
                    analysis += `     ‚îî‚îÄ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π: ${catModels.length}\n`;
                });

                analysis += '\n';
            });

            results.innerHTML = `
                <div class="bg-white rounded-lg p-4">
                    <h3 class="font-semibold mb-4">–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div class="bg-gray-50 p-3 rounded text-xs font-mono whitespace-pre">${analysis}</div>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            if (tg) {
                tg.expand();
            }
            feather.replace();
            debugLog('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.testAllEndpoints = testAllEndpoints;
        window.loadSections = loadSections;
        window.loadAllProducts = loadAllProducts;
        window.analyzeDataStructure = analyzeDataStructure;
        window.testCategories = testCategories;
        window.testModels = testModels;
        window.testSubmodels = testSubmodels;
        window.findProductsBySection = findProductsBySection;
        window.findProductsByCategory = findProductsByCategory;
        window.findProductsByModel = findProductsByModel;
        window.findProductsBySubmodel = findProductsBySubmodel;
        window.toggleDebug = toggleDebug;
    </script>
</body>
</html>
