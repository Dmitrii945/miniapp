from flask import Flask, jsonify, request
from flask_cors import CORS
import sqlite3
import uuid
import gspread
from google.oauth2.service_account import Credentials
import re
import logging
import os
import datetime
import requests

app = Flask(__name__)
CORS(app)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
GOOGLE_SHEETS_CREDS = '/home/Dmitrii2613/sservice/credentials.json'
SPREADSHEET_ID = '1gnZkDAI5P8gB4-P9zYcX3qcVUxpix1wgoYu_osv75Ec'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def check_credentials():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ credentials"""
    current_dir = os.path.dirname(os.path.abspath(__file__))
    creds_path = os.path.join(current_dir, GOOGLE_SHEETS_CREDS)

    print(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞: {creds_path}")

    if not os.path.exists(creds_path):
        print(f"‚ùå –§–∞–π–ª {GOOGLE_SHEETS_CREDS} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return False

    print(f"‚úÖ –§–∞–π–ª {GOOGLE_SHEETS_CREDS} –Ω–∞–π–¥–µ–Ω")
    return True

def get_google_sheets_data(range_name='A2:I1500'):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets"""
    try:
        scope = ['https://spreadsheets.google.com/feeds',
                'https://www.googleapis.com/auth/drive',
                'https://www.googleapis.com/auth/spreadsheets']

        creds = Credentials.from_service_account_file(GOOGLE_SHEETS_CREDS, scopes=scope)
        client = gspread.authorize(creds)
        sheet = client.open_by_key(SPREADSHEET_ID).sheet1

        data = sheet.get(range_name)
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ {len(data)} —Å—Ç—Ä–æ–∫")
        return data

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Google Sheets: {e}")
        return []

def get_brigades_data():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥ –∏–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ AA-AF"""
    try:
        print(f"üîß –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥...")

        scope = ['https://spreadsheets.google.com/feeds',
                'https://www.googleapis.com/auth/drive',
                'https://www.googleapis.com/auth/spreadsheets']

        creds = Credentials.from_service_account_file(GOOGLE_SHEETS_CREDS, scopes=scope)
        client = gspread.authorize(creds)
        sheet = client.open_by_key(SPREADSHEET_ID).sheet1

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ AA (–≥—Ä—É–ø–ø–∞), AB (–±—Ä–∏–≥–∞–¥–∞), AC (–æ–±—ä–µ–∫—Ç), AD (—Ñ–æ—Ç–æ), AE (–æ–ø–∏—Å–∞–Ω–∏–µ), AF (—Å—Ç–∞—Ç—É—Å)
        data = sheet.get('AA2:AF1000')
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ {len(data)} —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥")

        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö
        if data and len(data) > 0:
            print("üîç –ü–ï–†–í–´–ï 5 –°–¢–†–û–ö –î–ê–ù–ù–´–• –ë–†–ò–ì–ê–î:")
            for i, row in enumerate(data[:5]):
                print(f"  –°—Ç—Ä–æ–∫–∞ {i + 2}: {row}")

        return data

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥: {e}")
        return []

def parse_brigades_data(data):
    """–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ø–∞—Ä—Å–∏–Ω–≥ - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –±—Ä–∏–≥–∞–¥—ã –∏ –æ–±—ä–µ–∫—Ç–∞"""
    brigade_groups = {}
    current_group = None
    current_brigade = None
    current_object = None

    print(f"üîç –ù–∞—á–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ {len(data)} —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥")

    for row_index, row in enumerate(data):
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        if not any(cell and str(cell).strip() for cell in row):
            continue

        # –°—Ç–æ–ª–±–µ—Ü AA (–∏–Ω–¥–µ–∫—Å 0) - –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
        if len(row) > 0 and row[0] and str(row[0]).strip():
            current_group = str(row[0]).strip()
            if current_group not in brigade_groups:
                brigade_groups[current_group] = {
                    'group_name': current_group,
                    'brigades': []
                }
                print(f"  üìÅ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞: {current_group}")
            current_brigade = None
            current_object = None

        # –°—Ç–æ–ª–±–µ—Ü AB (–∏–Ω–¥–µ–∫—Å 1) - –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã
        if len(row) > 1 and row[1] and str(row[1]).strip():
            brigade_name = str(row[1]).strip()
            # –û–ü–ò–°–ê–ù–ò–ï –ë–†–ò–ì–ê–î–´ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤)
            full_description = str(row[4]).strip() if len(row) > 4 and row[4] else ''
            brigade_description = full_description[:100] + '...' if len(full_description) > 100 else full_description

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±—Ä–∏–≥–∞–¥—É
            current_brigade = {
                'brigade_name': brigade_name,
                'brigade_description': brigade_description or '–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –±—Ä–∏–≥–∞–¥–∞',
                'objects': []
            }
            brigade_groups[current_group]['brigades'].append(current_brigade)
            print(f"    üë∑ –°–æ–∑–¥–∞–Ω–∞ –±—Ä–∏–≥–∞–¥–∞: {brigade_name}")

            current_object = None

        # –°—Ç–æ–ª–±–µ—Ü AC (–∏–Ω–¥–µ–∫—Å 2) - –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –±—Ä–∏–≥–∞–¥–∞)
        if current_brigade and len(row) > 2 and row[2] and str(row[2]).strip():
            object_name = str(row[2]).strip()
            # –û–ü–ò–°–ê–ù–ò–ï –û–ë–™–ï–ö–¢–ê - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Å—Ç–æ–ª–±—Ü–∞ AE (–∏–Ω–¥–µ–∫—Å 4)
            object_description = str(row[4]).strip() if len(row) > 4 and row[4] else ''
            status = str(row[5]).strip() if len(row) > 5 and row[5] else '1'

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å –ü–û–õ–ù–´–ú –æ–ø–∏—Å–∞–Ω–∏–µ–º
            current_object = {
                'object_name': object_name,
                'object_description': object_description,  # –ü–û–õ–ù–û–ï –æ–ø–∏—Å–∞–Ω–∏–µ
                'status': status,
                'all_photos': []
            }
            current_brigade['objects'].append(current_object)
            print(f"      üè† –°–æ–∑–¥–∞–Ω –æ–±—ä–µ–∫—Ç: {object_name} (–æ–ø–∏—Å–∞–Ω–∏–µ: {len(object_description)} —Å–∏–º–≤–æ–ª–æ–≤)")

        # –°—Ç–æ–ª–±–µ—Ü AD (–∏–Ω–¥–µ–∫—Å 3) - —Ñ–æ—Ç–æ –æ–±—ä–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç)
        if current_object and len(row) > 3 and row[3] and str(row[3]).strip():
            photo_url = str(row[3]).strip()
            # –î–ª—è —Ñ–æ—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞)
            photo_description = current_object['object_name']

            # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –∫ —Ç–µ–∫—É—â–µ–º—É –æ–±—ä–µ–∫—Ç—É
            current_object['all_photos'].append({
                'photo_url': photo_url,
                'description': photo_description,  # –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ñ–æ—Ç–æ
                'status': current_object['status']
            })

    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä—É–ø–ø—ã, –±—Ä–∏–≥–∞–¥—ã –∏ –æ–±—ä–µ–∫—Ç—ã
    result = []
    for group_name, group_data in brigade_groups.items():
        valid_brigades = []
        for brigade in group_data['brigades']:
            # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—Ä–∏–≥–∞–¥—ã —Å –æ–±—ä–µ–∫—Ç–∞–º–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ñ–æ—Ç–æ
            valid_objects = [obj for obj in brigade['objects'] if obj['all_photos']]
            if valid_objects:
                brigade['objects'] = valid_objects
                valid_brigades.append(brigade)

        if valid_brigades:
            result.append({
                'group_name': group_name,
                'brigades': valid_brigades
            })

    print(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥—Ä—É–ø–ø –±—Ä–∏–≥–∞–¥: {len(result)}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    for group in result:
        for brigade in group['brigades']:
            print(f"  üë∑ –ë—Ä–∏–≥–∞–¥–∞: {brigade['brigade_name']}")
            print(f"    üìù –û–ø–∏—Å–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã: {len(brigade['brigade_description'])} —Å–∏–º–≤–æ–ª–æ–≤")
            for obj in brigade['objects']:
                print(f"    üè† –û–±—ä–µ–∫—Ç: {obj['object_name']}")
                print(f"      üìù –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: {len(obj.get('object_description', ''))} —Å–∏–º–≤–æ–ª–æ–≤")

    return result

def update_database_schema():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π"""
    conn = sqlite3.connect('/home/Dmitrii2613/catalog.db')
    cursor = conn.cursor()

    # –ò–∑–º–µ–Ω—è–µ–º —Ç–∏–ø –ø–æ–ª—è name –≤ —Ç–∞–±–ª–∏—Ü–µ hashes –Ω–∞ TEXT –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    try:
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS hashes_new (
            id INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            type TEXT NOT NULL,
            hash TEXT NOT NULL UNIQUE
        )
        ''')

        # –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã
        cursor.execute('INSERT INTO hashes_new SELECT * FROM hashes')

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é
        cursor.execute('DROP TABLE hashes')
        cursor.execute('ALTER TABLE hashes_new RENAME TO hashes')

        print("‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã: {e}")
        # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        conn.rollback()

    conn.commit()
    conn.close()


def parse_catalog_data(data):
    """–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞"""
    catalog = {}
    current_section = None
    current_category = None
    current_model = None
    current_submodel = None

    for i, row in enumerate(data):
        if len(row) < 3 or (row[0] == "–†–∞–∑–¥–µ–ª" and row[1] == "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"):
            continue

        if row[0]:
            current_section = row[0].strip()
            current_category = None
            current_model = None
            current_submodel = None

        if len(row) > 1 and row[1]:
            current_category = row[1].strip()
            current_model = None
            current_submodel = None

        if len(row) > 2 and row[2]:
            current_model = row[2].strip()
            current_submodel = None

        if len(row) > 3 and row[3]:
            current_submodel = row[3].strip()

        if not current_section or not current_category:
            continue

        color = row[4].strip() if len(row) > 4 and row[4] else None
        price = row[5].strip() if len(row) > 5 and row[5] else None
        photo_url = row[6].strip() if len(row) > 6 and row[6] else None
        description = row[7].strip() if len(row) > 7 and row[7] else None
        photo_description = row[8].strip() if len(row) > 8 and row[8] else None

        has_product_data = color or price or photo_url or description or photo_description

        if not has_product_data:
            continue

        if not current_model:
            current_model = "–ë–µ–∑ –º–æ–¥–µ–ª–∏"
            current_submodel = "–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏"
        elif not current_submodel:
            current_submodel = "–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏"

        if current_section not in catalog:
            catalog[current_section] = {}

        if current_category not in catalog[current_section]:
            catalog[current_section][current_category] = {}

        if current_model not in catalog[current_section][current_category]:
            catalog[current_section][current_category][current_model] = {}

        submodel_key = current_submodel if current_submodel else "–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏"

        if submodel_key not in catalog[current_section][current_category][current_model]:
            catalog[current_section][current_category][current_model][submodel_key] = []

        catalog[current_section][current_category][current_model][submodel_key].append({
            'color': color,
            'price': price,
            'photo_url': photo_url,
            'photo_id': photo_url,
            'row_index': i + 1,
            'description': description,
            'photo_description': photo_description
        })

    return catalog

def extract_numeric_price(price_str):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ü–µ–Ω—ã"""
    if not price_str or not isinstance(price_str, str):
        return float('inf')

    try:
        price_str = str(price_str).strip()
        if not price_str:
            return float('inf')

        clean_str = re.sub(r'[^\d,.]', '', price_str)
        if not clean_str:
            return float('inf')

        clean_str = clean_str.replace(',', '.')
        if clean_str.count('.') > 1:
            parts = clean_str.split('.')
            clean_str = parts[0] + '.' + ''.join(parts[1:])

        result = float(clean_str)
        return result

    except (ValueError, AttributeError, TypeError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã '{price_str}': {e}")
        return float('inf')

def get_min_price_in_category(catalog, section, category):
    """–ü–æ–ª—É—á–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    min_price = float('inf')

    if section in catalog and category in catalog[section]:
        for model in catalog[section][category].values():
            for submodel in model.values():
                for product in submodel:
                    if product['price']:
                        price_num = extract_numeric_price(product['price'])
                        if price_num != float('inf'):
                            min_price = min(min_price, price_num)

    return min_price if min_price != float('inf') else None

def get_min_price_in_model(catalog, section, category, model):
    """–ü–æ–ª—É—á–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ –º–æ–¥–µ–ª–∏"""
    min_price = float('inf')

    if (section in catalog and
        category in catalog[section] and
        model in catalog[section][category]):

        for submodel in catalog[section][category][model].values():
            for product in submodel:
                if product['price']:
                    price_num = extract_numeric_price(product['price'])
                    if price_num != float('inf'):
                        min_price = min(min_price, price_num)

    return min_price if min_price != float('inf') else None

def get_or_create_hash(name, hash_type):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —Ö—ç—à –¥–ª—è –∏–º–µ–Ω–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞)"""
    if name is None:
        name = "None"

    # –û–±—Ä–µ–∑–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ (–±–æ–ª–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤) —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    if len(name) > 1000:
        name = name[:1000] + "..."

    conn = sqlite3.connect('/home/Dmitrii2613/catalog.db')
    cursor = conn.cursor()

    cursor.execute('SELECT hash FROM hashes WHERE name = ? AND type = ?',
                  (name, hash_type))
    result = cursor.fetchone()

    if result:
        conn.close()
        return result[0]

    new_hash = str(uuid.uuid4()).replace('-', '')[:16]

    try:
        cursor.execute('INSERT INTO hashes (name, type, hash) VALUES (?, ?, ?)',
                      (name, hash_type, new_hash))
        conn.commit()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ö—ç—à–∞: {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö—ç—à –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏
        import hashlib
        new_hash = hashlib.md5(name.encode()).hexdigest()[:16]

    conn.close()
    return new_hash

def get_name_by_hash(target_hash):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–º—è –ø–æ —Ö—ç—à—É"""
    if not target_hash or target_hash == 'null' or target_hash == 'empty':
        return (None, None)

    conn = sqlite3.connect('/home/Dmitrii2613/catalog.db')
    cursor = conn.cursor()

    cursor.execute('SELECT name, type FROM hashes WHERE hash = ?', (target_hash,))
    result = cursor.fetchone()
    conn.close()

    return result if result else (None, None)

def extract_photo_filename_from_url(url):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ Google Drive"""
    try:
        if not url or not isinstance(url, str):
            return None

        url = url.strip()

        # –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if url.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp')):
            return url if url.startswith('http') else None

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ Google Drive —Å—Å—ã–ª–æ–∫
        if 'drive.google.com' in url:
            file_id = None

            # –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã Google Drive —Å—Å—ã–ª–æ–∫
            if '/file/d/' in url:
                file_id = url.split('/file/d/')[1].split('/')[0]
            elif 'id=' in url:
                file_id = url.split('id=')[1].split('&')[0]
            elif '/open?id=' in url:
                file_id = url.split('/open?id=')[1].split('&')[0]

            if file_id:
                return f"https://drive.google.com/uc?export=view&id={file_id}"
            else:
                return None

        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–∞—è HTTP —Å—Å—ã–ª–∫–∞
        if url.startswith(('http://', 'https://')):
            return url

        return None

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ URL: {e}")
        return None

def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect('/home/Dmitrii2613/catalog.db')
    cursor = conn.cursor()

    cursor.execute('''
    CREATE TABLE IF NOT EXISTS hashes (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        hash TEXT NOT NULL UNIQUE
    )
    ''')

    special_entries = [
        ("–ë–µ–∑ –º–æ–¥–µ–ª–∏", "model"),
        ("–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏", "submodel")
    ]

    for name, type_name in special_entries:
        cursor.execute('SELECT hash FROM hashes WHERE name = ? AND type = ?', (name, type_name))
        if not cursor.fetchone():
            new_hash = str(uuid.uuid4()).replace('-', '')[:16]
            cursor.execute('INSERT INTO hashes (name, type, hash) VALUES (?, ?, ?)',
                          (name, type_name, new_hash))

    conn.commit()
    conn.close()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

    update_database_schema()

init_database()

# ===== API ROUTES =====

@app.route('/api/debug/brigades_full')
def debug_brigades_full():
    """–ü–æ–ª–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∏–≥–∞–¥–∞—Ö"""
    try:
        print("üîç –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–†–ò–ì–ê–î")

        # –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        raw_data = get_brigades_data()
        print(f"üìä –°—ã—Ä—ã—Ö —Å—Ç—Ä–æ–∫: {len(raw_data)}")

        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        parsed_data = parse_brigades_data(raw_data)

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏—è
        description_analysis = []
        for group in parsed_data:
            for brigade in group['brigades']:
                for obj in brigade['objects']:
                    desc = obj.get('object_description', '')
                    desc_length = len(desc) if desc else 0
                    description_analysis.append({
                        'object_name': obj['object_name'],
                        'description_length': desc_length,
                        'description_preview': desc[:100] + '...' if desc_length > 100 else desc,
                        'has_description': bool(desc and desc.strip())
                    })

        return jsonify({
            'raw_data_count': len(raw_data),
            'parsed_groups_count': len(parsed_data),
            'total_objects': len(description_analysis),
            'objects_with_descriptions': len([x for x in description_analysis if x['has_description']]),
            'description_analysis': description_analysis,
            'sample_raw_row': raw_data[0] if raw_data else None
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/debug/check_sheets_data')
def debug_check_sheets_data():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets"""
    try:
        data = get_brigades_data()

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫
        analysis = []
        for i, row in enumerate(data[:10]):
            analysis.append({
                'row_number': i + 2,
                'columns_count': len(row),
                'group': row[0] if len(row) > 0 else None,
                'brigade': row[1] if len(row) > 1 else None,
                'object': row[2] if len(row) > 2 else None,
                'photo': row[3] if len(row) > 3 else None,
                'description': row[4] if len(row) > 4 else None,
                'description_length': len(row[4]) if len(row) > 4 and row[4] else 0,
                'status': row[5] if len(row) > 5 else None
            })

        return jsonify({
            'total_rows': len(data),
            'row_analysis': analysis
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/')
def hello_world():
    return jsonify({
        'status': 'ok',
        'message': 'Mini App API —Ä–∞–±–æ—Ç–∞–µ—Ç!',
        'endpoints': {
            'sections': '/api/sections',
            'categories': '/api/categories/<section_hash>',
            'models': '/api/models/<section_hash>/<category_hash>',
            'submodels': '/api/submodels/<section_hash>/<category_hash>/<model_hash>',
            'products': '/api/products/<section_hash>/<category_hash>/<model_hash>/<submodel_hash>',
            'brigades': '/api/brigades',
            'products_by_section': '/api/products_by_section/<section_hash>',
            'products_by_category': '/api/products_by_category/<section_hash>/<category_hash>',
            'products_by_model': '/api/products_by_model/<section_hash>/<category_hash>/<model_hash>',
            'products_by_submodel': '/api/products_by_submodel/<section_hash>/<category_hash>/<model_hash>/<submodel_hash>'
        }
    })

@app.route('/api/brigades')
def api_get_brigades():
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥"""
    try:
        print("=" * 50)
        print("üîÑ –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò /api/brigades")

        if not check_credentials():
            # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            test_brigades = [
                {
                    'group_name': '–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –±—Ä–∏–≥–∞–¥—ã',
                    'brigades': [
                        {
                            'brigade_name': '–ë—Ä–∏–≥–∞–¥–∞ 1',
                            'brigade_description': '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –±—Ä–∏–≥–∞–¥–∞',
                            'objects': [
                                {
                                    'object_name': '–û–±—ä–µ–∫—Ç 1',
                                    'object_description': '–ñ–∏–ª–æ–π –¥–æ–º –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞ —Å –ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–º–∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–æ–º',
                                    'status': '1',
                                    'all_photos': [
                                        {
                                            'photo_url': 'https://drive.google.com/uc?export=view&id=test1',
                                            'description': '–§–∞—Å–∞–¥ –∑–¥–∞–Ω–∏—è',
                                            'status': '1'
                                        },
                                        {
                                            'photo_url': 'https://drive.google.com/uc?export=view&id=test2',
                                            'description': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞',
                                            'status': '1'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
            return jsonify({'brigades': test_brigades})

        print("üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥ –∏–∑ Google Sheets...")
        data = get_brigades_data()
        print(f"üìä –ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥: {len(data)}")

        if not data:
            print("‚ùå Google Sheets –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–∏–≥–∞–¥")
            return jsonify({'brigades': []})

        print("üîç –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∏–≥–∞–¥ –ø–æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô —Å—Ç—Ä—É–∫—Ç—É—Ä–µ...")
        brigades = parse_brigades_data(data)
        print(f"üìÇ –ì—Ä—É–ø–ø –±—Ä–∏–≥–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: {len(brigades)}")

        # –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if brigades:
            print("üìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–†–ò–ì–ê–î–ê–•:")
            for group_index, group in enumerate(brigades):
                print(f"  üìÅ –ì—Ä—É–ø–ø–∞ {group_index + 1}: {group['group_name']}")
                for brigade_index, brigade in enumerate(group['brigades']):
                    print(f"    üë∑ –ë—Ä–∏–≥–∞–¥–∞ {brigade_index + 1}: {brigade['brigade_name']}")
                    print(f"      üìù –û–ø–∏—Å–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã: {brigade.get('brigade_description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}")
                    for obj_index, obj in enumerate(brigade['objects']):
                        print(f"      üè† –û–±—ä–µ–∫—Ç {obj_index + 1}: {obj['object_name']}")
                        print(f"        üìù –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: {obj.get('object_description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}")
                        print(f"        üî¢ –°—Ç–∞—Ç—É—Å: {obj.get('status', '1')}")
                        print(f"        üì∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: {len(obj.get('all_photos', []))}")
        else:
            print("‚ùå –î–∞–Ω–Ω—ã–µ –±—Ä–∏–≥–∞–¥ –ø—É—Å—Ç—ã–µ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞")

        print(f"‚úÖ –ò–¢–û–ì–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(brigades)} –≥—Ä—É–ø–ø –±—Ä–∏–≥–∞–¥")
        print("=" * 50)
        return jsonify({'brigades': brigades})

    except Exception as e:
        logger.error(f"API brigades error: {e}")
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        print(f"üìã Traceback: {traceback.format_exc()}")

        return jsonify({'brigades': []})

@app.route('/api/sections')
def api_get_sections():
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤"""
    try:
        print("=" * 50)
        print("üîÑ –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò /api/sections")

        if not check_credentials():
            test_sections = [
                {'name': '–ú–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç (—Ç–µ—Å—Ç)', 'id': 'test1'},
                {'name': '–ö—Ä–æ–≤–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (—Ç–µ—Å—Ç)', 'id': 'test2'},
            ]
            return jsonify({'sections': test_sections})

        print("üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...")
        data = get_google_sheets_data('A2:I1500')
        print(f"üìä –ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∏–∑ Google Sheets: {len(data)}")

        if not data:
            print("‚ùå Google Sheets –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ")
            return jsonify({'sections': []})

        print("üîç –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–∞–ª–æ–≥–∞...")
        catalog = parse_catalog_data(data)
        print(f"üìÇ –†–∞–∑–¥–µ–ª–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: {len(catalog)}")

        if catalog:
            print("üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:")
            for section in catalog.keys():
                print(f"  - {section}")
        else:
            print("‚ùå –ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç–æ–π –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞")

        sections = []
        for section_name in sorted(catalog.keys()):
            section_hash = get_or_create_hash(section_name, 'section')
            sections.append({
                'name': section_name,
                'id': section_hash
            })
            print(f"  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª: {section_name} -> {section_hash}")

        print(f"‚úÖ –ò–¢–û–ì–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(sections)} —Ä–∞–∑–¥–µ–ª–æ–≤")
        print("=" * 50)
        return jsonify({'sections': sections})

    except Exception as e:
        logger.error(f"API sections error: {e}")
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        print(f"üìã Traceback: {traceback.format_exc()}")

        return jsonify({'sections': [
            {'name': '–û–®–ò–ë–ö–ê: ' + str(e), 'id': 'error'}
        ]})

@app.route('/api/categories/<section_hash>')
def api_get_categories(section_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞–∑–¥–µ–ª–∞"""
    try:
        print(f"üîç –ó–ê–ü–†–û–° –ö–ê–¢–ï–ì–û–†–ò–ô –î–õ–Ø –†–ê–ó–î–ï–õ–ê: {section_hash}")
        section_name, _ = get_name_by_hash(section_hash)
        print(f"üìÇ –ù–∞–π–¥–µ–Ω —Ä–∞–∑–¥–µ–ª: {section_name}")

        if not section_name:
            print("‚ùå –†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ —Ö—ç—à—É")
            return jsonify({'categories': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        print(f"üìä –ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω, —Ä–∞–∑–¥–µ–ª–æ–≤: {len(catalog)}")

        categories = []
        if section_name in catalog:
            print(f"üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ '{section_name}': {list(catalog[section_name].keys())}")

            for category_name in sorted(catalog[section_name].keys()):
                min_price = get_min_price_in_category(catalog, section_name, category_name)

                categories.append({
                    'name': category_name,
                    'id': get_or_create_hash(category_name, 'category'),
                    'min_price': min_price if min_price != float('inf') else None
                })
                print(f"  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}")

        print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(categories)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
        return jsonify({
            'section_name': section_name,
            'categories': categories
        })

    except Exception as e:
        logger.error(f"API categories error: {e}")
        print(f"‚ùå –û–®–ò–ë–ö–ê –≤ categories: {e}")
        return jsonify({'categories': []})

@app.route('/api/models/<section_hash>/<category_hash>')
def api_get_models(section_hash, category_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    try:
        print(f"üîç –ó–ê–ü–†–û–° –ú–û–î–ï–õ–ï–ô: section={section_hash}, category={category_hash}")

        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        print(f"üìÇ –ù–∞–π–¥–µ–Ω –ø—É—Ç—å: {section_name} -> {category_name}")

        if not section_name or not category_name:
            print("‚ùå –†–∞–∑–¥–µ–ª –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return jsonify({'models': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        models = []
        if (section_name in catalog and
            category_name in catalog[section_name]):

            print(f"üìã –ú–æ–¥–µ–ª–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{category_name}': {list(catalog[section_name][category_name].keys())}")

            for model_name in sorted(catalog[section_name][category_name].keys()):
                min_price = get_min_price_in_model(catalog, section_name, category_name, model_name)
                models.append({
                    'name': model_name,
                    'id': get_or_create_hash(model_name, 'model'),
                    'min_price': min_price if min_price != float('inf') else None
                })
                print(f"  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å: {model_name}")

        print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(models)} –º–æ–¥–µ–ª–µ–π")
        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'models': models
        })

    except Exception as e:
        logger.error(f"API models error: {e}")
        print(f"‚ùå –û–®–ò–ë–ö–ê –≤ models: {e}")
        return jsonify({'models': []})

@app.route('/api/submodels/<section_hash>/<category_hash>/<model_hash>')
def api_get_submodels(section_hash, category_hash, model_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–º–æ–¥–µ–ª–µ–π"""
    try:
        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        if model_hash == 'null' or model_hash == 'empty':
            model_name = "–ë–µ–∑ –º–æ–¥–µ–ª–∏"
        else:
            model_name, _ = get_name_by_hash(model_hash)

        print(f"üîç –ó–ê–ü–†–û–° –ü–û–î–ú–û–î–ï–õ–ï–ô: {section_name} -> {category_name} -> {model_name}")

        if not all([section_name, category_name, model_name]):
            return jsonify({'submodels': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        submodels = []
        if (section_name in catalog and
            category_name in catalog[section_name] and
            model_name in catalog[section_name][category_name]):

            submodels_data = catalog[section_name][category_name][model_name]

            for submodel_name in sorted(submodels_data.keys()):
                products = submodels_data[submodel_name]
                min_price = float('inf')

                for product in products:
                    if product['price']:
                        price_num = extract_numeric_price(product['price'])
                        if price_num != float('inf'):
                            min_price = min(min_price, price_num)

                submodels.append({
                    'name': submodel_name,
                    'id': get_or_create_hash(submodel_name, 'submodel'),
                    'min_price': min_price if min_price != float('inf') else None,
                    'product_count': len(products)
                })
                print(f"  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–º–æ–¥–µ–ª—å: {submodel_name} ({len(products)} —Ç–æ–≤–∞—Ä–æ–≤)")

        print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(submodels)} –ø–æ–¥–º–æ–¥–µ–ª–µ–π")
        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'model_name': model_name,
            'submodels': submodels
        })
    except Exception as e:
        logger.error(f"API submodels error: {e}")
        print(f"‚ùå –û–®–ò–ë–ö–ê –≤ submodels: {e}")
        return jsonify({'submodels': []})

@app.route('/api/products/<section_hash>/<category_hash>/<model_hash>/<submodel_hash>')
def api_get_products(section_hash, category_hash, model_hash, submodel_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤"""
    try:
        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        if model_hash == 'null' or model_hash == 'empty':
            model_name = "–ë–µ–∑ –º–æ–¥–µ–ª–∏"
        else:
            model_name, _ = get_name_by_hash(model_hash)

        if submodel_hash == 'null' or submodel_hash == 'empty':
            submodel_name = "–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏"
        else:
            submodel_name, _ = get_name_by_hash(submodel_hash)

        print(f"üîç –ó–ê–ü–†–û–° –¢–û–í–ê–†–û–í: {section_name} -> {category_name} -> {model_name} -> {submodel_name}")

        if not all([section_name, category_name, model_name, submodel_name]):
            print("‚ùå –ù–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–π–¥–µ–Ω—ã –ø–æ —Ö—ç—à–∞–º")
            return jsonify({'products': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        products = []
        if (section_name in catalog and
            category_name in catalog[section_name] and
            model_name in catalog[section_name][category_name] and
            submodel_name in catalog[section_name][category_name][model_name]):

            raw_products = catalog[section_name][category_name][model_name][submodel_name]
            print(f"üì¶ –ù–∞–π–¥–µ–Ω–æ —Å—ã—Ä—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: {len(raw_products)}")

            for product in raw_products:
                photo_url = extract_photo_filename_from_url(product.get('photo_url'))

                processed_product = {
                    'color': product['color'],
                    'price': product['price'],
                    'photo_url': photo_url,
                    'photo_description': product.get('photo_description', ''),
                    'description': product.get('description', ''),
                    'row_index': product['row_index']
                }
                products.append(processed_product)
                print(f"  ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω —Ç–æ–≤–∞—Ä: {product['color']}, —Ñ–æ—Ç–æ: {photo_url}")

        print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(products)} —Ç–æ–≤–∞—Ä–æ–≤")
        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'model_name': model_name,
            'submodel_name': submodel_name,
            'products': products
        })
    except Exception as e:
        logger.error(f"API products error: {e}")
        print(f"‚ùå –û–®–ò–ë–ö–ê –≤ products: {e}")
        import traceback
        print(f"üìã Traceback: {traceback.format_exc()}")
        return jsonify({'products': []})

@app.route('/api/products_by_section/<section_hash>')
def api_get_products_by_section(section_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Ä–∞–∑–¥–µ–ª–∞"""
    try:
        section_name, _ = get_name_by_hash(section_hash)

        if not section_name:
            return jsonify({'products': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        products = []
        if section_name in catalog:
            for category_name in catalog[section_name].keys():
                for model_name in catalog[section_name][category_name].keys():
                    for submodel_name in catalog[section_name][category_name][model_name].keys():
                        raw_products = catalog[section_name][category_name][model_name][submodel_name]
                        for product in raw_products:
                            photo_url = extract_photo_filename_from_url(product.get('photo_url'))

                            processed_product = {
                                'color': product['color'],
                                'price': product['price'],
                                'photo_url': photo_url,
                                'photo_description': product.get('photo_description', ''),
                                'description': product.get('description', ''),
                                'section': section_name,
                                'category': category_name,
                                'model': model_name,
                                'submodel': submodel_name
                            }
                            products.append(processed_product)

        return jsonify({
            'section_name': section_name,
            'products': products
        })
    except Exception as e:
        logger.error(f"API products_by_section error: {e}")
        return jsonify({'products': []})

@app.route('/api/products_by_category/<section_hash>/<category_hash>')
def api_get_products_by_category(section_hash, category_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    try:
        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        if not section_name or not category_name:
            return jsonify({'products': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        products = []
        if (section_name in catalog and
            category_name in catalog[section_name]):

            for model_name in catalog[section_name][category_name].keys():
                for submodel_name in catalog[section_name][category_name][model_name].keys():
                    raw_products = catalog[section_name][category_name][model_name][submodel_name]
                    for product in raw_products:
                        photo_url = extract_photo_filename_from_url(product.get('photo_url'))

                        processed_product = {
                            'color': product['color'],
                            'price': product['price'],
                            'photo_url': photo_url,
                            'photo_description': product.get('photo_description', ''),
                            'description': product.get('description', ''),
                            'section': section_name,
                            'category': category_name,
                            'model': model_name,
                            'submodel': submodel_name
                        }
                        products.append(processed_product)

        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'products': products
        })
    except Exception as e:
        logger.error(f"API products_by_category error: {e}")
        return jsonify({'products': []})

@app.route('/api/products_by_model/<section_hash>/<category_hash>/<model_hash>')
def api_get_products_by_model(section_hash, category_hash, model_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –º–æ–¥–µ–ª–∏"""
    try:
        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        if model_hash == 'null' or model_hash == 'empty':
            model_name = "–ë–µ–∑ –º–æ–¥–µ–ª–∏"
        else:
            model_name, _ = get_name_by_hash(model_hash)

        if not section_name or not category_name or not model_name:
            return jsonify({'products': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        products = []
        if (section_name in catalog and
            category_name in catalog[section_name] and
            model_name in catalog[section_name][category_name]):

            for submodel_name in catalog[section_name][category_name][model_name].keys():
                raw_products = catalog[section_name][category_name][model_name][submodel_name]
                for product in raw_products:
                    photo_url = extract_photo_filename_from_url(product.get('photo_url'))

                    processed_product = {
                        'color': product['color'],
                        'price': product['price'],
                        'photo_url': photo_url,
                        'photo_description': product.get('photo_description', ''),
                        'description': product.get('description', ''),
                        'section': section_name,
                        'category': category_name,
                        'model': model_name,
                        'submodel': submodel_name
                    }
                    products.append(processed_product)

        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'model_name': model_name,
            'products': products
        })
    except Exception as e:
        logger.error(f"API products_by_model error: {e}")
        return jsonify({'products': []})

@app.route('/api/products_by_submodel/<section_hash>/<category_hash>/<model_hash>/<submodel_hash>')
def api_get_products_by_submodel(section_hash, category_hash, model_hash, submodel_hash):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–¥–º–æ–¥–µ–ª–∏"""
    try:
        section_name, _ = get_name_by_hash(section_hash)
        category_name, _ = get_name_by_hash(category_hash)

        if model_hash == 'null' or model_hash == 'empty':
            model_name = "–ë–µ–∑ –º–æ–¥–µ–ª–∏"
        else:
            model_name, _ = get_name_by_hash(model_hash)

        if submodel_hash == 'null' or submodel_hash == 'empty':
            submodel_name = "–ë–µ–∑ –ø–æ–¥–º–æ–¥–µ–ª–∏"
        else:
            submodel_name, _ = get_name_by_hash(submodel_hash)

        if not all([section_name, category_name, model_name, submodel_name]):
            return jsonify({'products': []})

        data = get_google_sheets_data('A2:I1500')
        catalog = parse_catalog_data(data)

        products = []
        if (section_name in catalog and
            category_name in catalog[section_name] and
            model_name in catalog[section_name][category_name] and
            submodel_name in catalog[section_name][category_name][model_name]):

            raw_products = catalog[section_name][category_name][model_name][submodel_name]
            for product in raw_products:
                photo_url = extract_photo_filename_from_url(product.get('photo_url'))

                processed_product = {
                    'color': product['color'],
                    'price': product['price'],
                    'photo_url': photo_url,
                    'photo_description': product.get('photo_description', ''),
                    'description': product.get('description', ''),
                    'section': section_name,
                    'category': category_name,
                    'model': model_name,
                    'submodel': submodel_name
                }
                products.append(processed_product)

        return jsonify({
            'section_name': section_name,
            'category_name': category_name,
            'model_name': model_name,
            'submodel_name': submodel_name,
            'products': products
        })
    except Exception as e:
        logger.error(f"API products_by_submodel error: {e}")
        return jsonify({'products': []})

# ===== –ß–ê–¢–´ =====

@app.route('/api/chat/start', methods=['POST'])
def api_start_chat():
    """API –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞ —Å –±—Ä–∏–≥–∞–¥–æ–π"""
    try:
        data = request.json
        user_id = data.get('user_id')
        user_name = data.get('user_name')
        brigade_name = data.get('brigade_name')
        object_name = data.get('object_name')

        if not all([user_id, user_name, brigade_name]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∏–≥–∞–¥–µ –∏–∑ Google Sheets
        try:
            brigade_data = get_brigades_data()
            brigade_info = None
            
            # –ò—â–µ–º –Ω—É–∂–Ω—É—é –±—Ä–∏–≥–∞–¥—É
            for row in brigade_data:
                if len(row) > 0 and row[0] == brigade_name:
                    brigade_info = {
                        'name': row[0],
                        'telegram_id': row[32] if len(row) > 32 else None  # –ö–æ–ª–æ–Ω–∫–∞ AG (33-—è –∫–æ–ª–æ–Ω–∫–∞, –∏–Ω–¥–µ–∫—Å 32)
                    }
                    break
            
            if brigade_info and brigade_info['telegram_id']:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç
                BOT_TOKEN = "7225116016:AAFBknnKHxbZwmjtODXTk-PuM3VjFbw_6LA"
                telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
                
                message = f"üîî *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—â–µ–Ω–∏–µ*\n\n"
                message += f"üë§ *–û—Ç:* {user_name}\n"
                message += f"üë∑ *–ë—Ä–∏–≥–∞–¥–∞:* {brigade_name}\n"
                if object_name:
                    message += f"üè† *–û–±—ä–µ–∫—Ç:* {object_name}\n"
                message += f"üïê *–í—Ä–µ–º—è:* {datetime.datetime.now().strftime('%H:%M %d.%m.%Y')}"
                
                telegram_data = {
                    'chat_id': brigade_info['telegram_id'],
                    'text': message,
                    'parse_mode': 'Markdown'
                }
                
                response = requests.post(telegram_url, json=telegram_data, timeout=5)
                logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±—Ä–∏–≥–∞–¥–µ {brigade_name}: {response.status_code}")
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        session_id = f"{user_id}_{brigade_name}_{object_name or 'general'}_{int(datetime.datetime.now().timestamp())}"
        
        return jsonify({
            'success': True,
            'session_id': session_id,
            'message': '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±—Ä–∏–≥–∞–¥–µ'
        })

    except Exception as e:
        logger.error(f"API start_chat error: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/chat/send_message', methods=['POST'])
def api_send_chat_message():
    """API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç"""
    try:
        data = request.json
        session_id = data.get('session_id')
        user_id = data.get('user_id')
        user_name = data.get('user_name')
        brigade_name = data.get('brigade_name')
        object_name = data.get('object_name')
        message_text = data.get('message_text')

        if not all([session_id, user_id, message_text, brigade_name]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–µ
        try:
            brigade_data = get_brigades_data()
            brigade_info = None
            
            for row in brigade_data:
                if len(row) > 0 and row[0] == brigade_name:
                    brigade_info = {
                        'name': row[0],
                        'telegram_id': row[32] if len(row) > 32 else None
                    }
                    break
            
            if brigade_info and brigade_info['telegram_id']:
                BOT_TOKEN = "7225116016:AAFBknnKHxbZwmjtODXTk-PuM3VjFbw_6LA"
                telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
                
                message = f"üí¨ *–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_name}*\n\n"
                message += f"üë∑ *–ë—Ä–∏–≥–∞–¥–∞:* {brigade_name}\n"
                if object_name:
                    message += f"üè† *–û–±—ä–µ–∫—Ç:* {object_name}\n"
                message += f"\nüìù *–°–æ–æ–±—â–µ–Ω–∏–µ:*\n{message_text}"
                
                telegram_data = {
                    'chat_id': brigade_info['telegram_id'],
                    'text': message,
                    'parse_mode': 'Markdown'
                }
                
                response = requests.post(telegram_url, json=telegram_data, timeout=5)
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±—Ä–∏–≥–∞–¥–µ {brigade_name}: {response.status_code}")
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram: {e}")
        
        return jsonify({
            'success': True,
            'message': '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'
        })

    except Exception as e:
        logger.error(f"API send_message error: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5001, host='0.0.0.0')
