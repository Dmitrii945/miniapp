<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–¢–†–û–ô–ë–ê–¢ –ö–∞—Ç–∞–ª–æ–≥ - –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-button-color: #3B82F6;
            --tg-theme-button-text-color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-md mx-auto p-4">
        <h1 class="text-xl font-bold mb-4">–ü–æ–∏—Å–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤</h1>
        
        <div class="space-y-4">
            <button onclick="findProductsEndpoints()" class="w-full py-3 bg-blue-500 text-white rounded-lg font-medium">
                –ù–∞–π—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤
            </button>
            
            <button onclick="testCommonEndpoints()" class="w-full py-3 bg-green-500 text-white rounded-lg font-medium">
                –¢–µ—Å—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
            </button>
            
            <button onclick="loadSections()" class="w-full py-3 bg-purple-500 text-white rounded-lg font-medium">
                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∞
            </button>
        </div>
        
        <div id="results" class="mt-6 space-y-4"></div>
        <div id="debug" class="mt-4 p-3 bg-gray-100 rounded text-xs font-mono max-h-60 overflow-y-auto"></div>
    </div>

    <script>
        const API_BASE = 'https://dmitrii2613.pythonanywhere.com/api';
        
        function debugLog(message) {
            const debug = document.getElementById('debug');
            debug.innerHTML += message + '\n';
            debug.scrollTop = debug.scrollHeight;
        }

        async function apiFetch(endpoint) {
            try {
                debugLog(`üîç GET ${endpoint}`);
                const response = await fetch(`${API_BASE}${endpoint}`);
                
                if (!response.ok) {
                    debugLog(`‚ùå ${response.status} ${endpoint}`);
                    return null;
                }
                
                const data = await response.json();
                debugLog(`‚úÖ ${endpoint} - –Ω–∞–π–¥–µ–Ω–æ: ${Object.values(data)[0]?.length || 0} –∑–∞–ø–∏—Å–µ–π`);
                return data;
            } catch (error) {
                debugLog(`‚ùå –û—à–∏–±–∫–∞: ${endpoint} - ${error.message}`);
                return null;
            }
        }

        async function findProductsEndpoints() {
            debugLog('\n=== –ü–û–ò–°–ö –≠–ù–î–ü–û–ò–ù–¢–û–í –¢–û–í–ê–†–û–í ===');
            
            const possibleEndpoints = [
                '/products',
                '/items', 
                '/goods',
                '/all',
                '/all_items',
                '/all_goods',
                '/catalog',
                '/products/all',
                '/items/all',
                '/goods/all'
            ];

            const results = document.getElementById('results');
            results.innerHTML = '<div class="text-center py-4">–ü–æ–∏—Å–∫...</div>';

            let foundEndpoints = [];

            for (const endpoint of possibleEndpoints) {
                const data = await apiFetch(endpoint);
                if (data && Object.values(data)[0]?.length > 0) {
                    foundEndpoints.push({
                        endpoint,
                        count: Object.values(data)[0].length,
                        sample: JSON.stringify(data).substring(0, 200)
                    });
                }
            }

            if (foundEndpoints.length > 0) {
                let html = '<div class="bg-green-50 p-4 rounded border border-green-200"><h3 class="font-semibold text-green-800 mb-2">–ù–∞–π–¥–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:</h3>';
                foundEndpoints.forEach(item => {
                    html += `
                        <div class="mb-3 p-3 bg-white rounded border">
                            <div class="font-mono text-sm bg-green-100 p-1 rounded">${item.endpoint}</div>
                            <div class="text-sm mt-1">–ó–∞–ø–∏—Å–µ–π: ${item.count}</div>
                            <div class="text-xs mt-1 text-gray-600">${item.sample}...</div>
                        </div>
                    `;
                });
                html += '</div>';
                results.innerHTML = html;
            } else {
                results.innerHTML = '<div class="bg-red-50 p-4 rounded border border-red-200 text-red-800">‚ùå –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
        }

        async function testCommonEndpoints() {
            debugLog('\n=== –¢–ï–°–¢ –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ù–´–• –≠–ù–î–ü–û–ò–ù–¢–û–í ===');
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
            const testCases = [
                // –ë–∞–∑–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
                { endpoint: '/products', description: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã' },
                { endpoint: '/items', description: '–í—Å–µ items' },
                
                // –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ ID
                { endpoint: '/products/section/dcb1364bebe64073', description: '–¢–æ–≤–∞—Ä—ã –ø–æ —Ä–∞–∑–¥–µ–ª—É' },
                { endpoint: '/items/section/dcb1364bebe64073', description: 'Items –ø–æ —Ä–∞–∑–¥–µ–ª—É' },
                { endpoint: '/products/category/3d13eaa317c84d8c', description: '–¢–æ–≤–∞—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' },
                { endpoint: '/items/category/3d13eaa317c84d8c', description: 'Items –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' },
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                { endpoint: '/section/dcb1364bebe64073/products', description: '–¢–æ–≤–∞—Ä—ã —Ä–∞–∑–¥–µ–ª–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)' },
                { endpoint: '/category/3d13eaa317c84d8c/products', description: '–¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)' },
                
                // –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                { endpoint: '/products/dcb1364bebe64073/3d13eaa317c84d8c', description: '–¢–æ–≤–∞—Ä—ã —Ä–∞–∑–¥–µ–ª–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' },
                { endpoint: '/items/dcb1364bebe64073/3d13eaa317c84d8c', description: 'Items —Ä–∞–∑–¥–µ–ª–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }
            ];

            const results = document.getElementById('results');
            results.innerHTML = '<div class="text-center py-4">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';

            let workingEndpoints = [];

            for (const test of testCases) {
                const data = await apiFetch(test.endpoint);
                if (data) {
                    const count = Object.values(data)[0]?.length || 0;
                    if (count > 0) {
                        workingEndpoints.push({
                            ...test,
                            count: count
                        });
                    }
                }
            }

            if (workingEndpoints.length > 0) {
                let html = '<div class="bg-green-50 p-4 rounded border border-green-200"><h3 class="font-semibold text-green-800 mb-2">–†–∞–±–æ—Ç–∞—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:</h3>';
                workingEndpoints.forEach(item => {
                    html += `
                        <div class="mb-3 p-3 bg-white rounded border">
                            <div class="font-semibold">${item.description}</div>
                            <div class="font-mono text-sm bg-green-100 p-1 rounded mt-1">${item.endpoint}</div>
                            <div class="text-sm mt-1">–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${item.count}</div>
                        </div>
                    `;
                });
                html += '</div>';
                results.innerHTML = html;
            } else {
                results.innerHTML = '<div class="bg-red-50 p-4 rounded border border-red-200 text-red-800">‚ùå –ù–∏ –æ–¥–∏–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–≤–∞—Ä—ã</div>';
            }
        }

        async function loadSections() {
            debugLog('\n=== –ó–ê–ì–†–£–ó–ö–ê –†–ê–ó–î–ï–õ–û–í –î–õ–Ø –¢–ï–°–¢–ê ===');
            
            const data = await apiFetch('/sections');
            if (!data?.sections) {
                debugLog('‚ùå –†–∞–∑–¥–µ–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }

            const results = document.getElementById('results');
            let html = '<div class="bg-blue-50 p-4 rounded border border-blue-200"><h3 class="font-semibold text-blue-800 mb-2">–†–∞–∑–¥–µ–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>';
            
            data.sections.forEach(section => {
                html += `
                    <div class="mb-3 p-3 bg-white rounded border">
                        <div class="font-semibold">${section.name}</div>
                        <div class="text-sm text-gray-600">ID: ${section.id}</div>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="testSectionProducts('${section.id}', '${section.name}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                                –¢–µ—Å—Ç —Ç–æ–≤–∞—Ä–æ–≤
                            </button>
                            <button onclick="loadCategories('${section.id}', '${section.name}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                –¢–µ—Å—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            results.innerHTML = html;
        }

        async function testSectionProducts(sectionId, sectionName) {
            debugLog(`\n=== –¢–ï–°–¢ –¢–û–í–ê–†–û–í –î–õ–Ø –†–ê–ó–î–ï–õ–ê ${sectionName} ===`);
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
            const endpoints = [
                `/products/section/${sectionId}`,
                `/items/section/${sectionId}`,
                `/section/${sectionId}/products`,
                `/section/${sectionId}/items`,
                `/catalog/${sectionId}`,
                `/products?section_id=${sectionId}`,
                `/items?section_id=${sectionId}`
            ];

            for (const endpoint of endpoints) {
                await apiFetch(endpoint);
            }
        }

        async function loadCategories(sectionId, sectionName) {
            debugLog(`\n=== –ö–ê–¢–ï–ì–û–†–ò–ò –î–õ–Ø –†–ê–ó–î–ï–õ–ê ${sectionName} ===`);
            
            const data = await apiFetch(`/categories/${sectionId}`);
            if (!data?.categories) {
                debugLog('‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            const results = document.getElementById('results');
            let html = `<div class="bg-green-50 p-4 rounded border border-green-200"><h3 class="font-semibold text-green-800 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ "${sectionName}":</h3>`;
            
            data.categories.forEach(category => {
                html += `
                    <div class="mb-3 p-3 bg-white rounded border">
                        <div class="font-semibold">${category.name}</div>
                        <div class="text-sm text-gray-600">ID: ${category.id}</div>
                        <button onclick="testCategoryProducts('${sectionId}', '${sectionName}', '${category.id}', '${category.name}')" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm">
                            –¢–µ—Å—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            results.innerHTML = html;
        }

        async function testCategoryProducts(sectionId, sectionName, categoryId, categoryName) {
            debugLog(`\n=== –¢–ï–°–¢ –¢–û–í–ê–†–û–í –î–õ–Ø –ö–ê–¢–ï–ì–û–†–ò–ò ${categoryName} ===`);
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const endpoints = [
                `/products/category/${categoryId}`,
                `/items/category/${categoryId}`,
                `/category/${categoryId}/products`,
                `/category/${categoryId}/items`,
                `/products/${sectionId}/${categoryId}`,
                `/items/${sectionId}/${categoryId}`,
                `/products?section_id=${sectionId}&category_id=${categoryId}`,
                `/items?section_id=${sectionId}&category_id=${categoryId}`
            ];

            for (const endpoint of endpoints) {
                await apiFetch(endpoint);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            debugLog('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
        });

        window.findProductsEndpoints = findProductsEndpoints;
        window.testCommonEndpoints = testCommonEndpoints;
        window.loadSections = loadSections;
        window.testSectionProducts = testSectionProducts;
        window.loadCategories = loadCategories;
        window.testCategoryProducts = testCategoryProducts;
    </script>
</body>
</html>
