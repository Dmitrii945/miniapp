<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ö–ò–î–ö–ê –°–ï–†–í–ò–° –ö–∞—Ç–∞–ª–æ–≥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –°–¢–ò–õ–ò –ß–ê–¢–ê */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
        }

        .chat-header {
            padding: 16px;
            background: #3B82F6;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            outline: none;
        }

        .chat-send-btn {
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
        }

        .message-user {
            align-self: flex-end;
            background: #3B82F6;
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message-brigade {
            align-self: flex-start;
            background: #f3f4f6;
            color: #374151;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message-sending {
            opacity: 0.7;
        }

        .message-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #3B82F6;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            z-index: 999;
            border: none;
        }

        .chat-toggle.visible {
            display: flex;
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        .product-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
        }

        .category-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
        }

        .price-badge {
            background-color: #10B981;
            color: white;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .universal-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .universal-image-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .universal-image-placeholder {
            width: 100%;
            height: 100%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .action-button {
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: white;
        }

        .phone-button {
            background-color: #10B981;
        }

        .share-button {
            background-color: #EC4899;
        }

        .back-button {
            background-color: #6B7280;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-md mx-auto">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button onclick="openSideMenu()" class="p-2 rounded-lg hover:bg-gray-100">
                    <i data-feather="menu"></i>
                </button>
                <div class="text-center">
                    <h1 class="text-lg font-semibold" id="pageTitle">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
                    <div class="text-gray-500 text-sm">–°–∫–∏–¥–∫–∞ –°–µ—Ä–≤–∏—Å</div>
                </div>
                <button onclick="installPWA()" class="p-2 rounded-lg hover:bg-gray-100">
                    <i data-feather="plus-square"></i>
                </button>
            </div>
            <div id="breadcrumbs" class="flex items-center text-sm mt-2 overflow-x-auto whitespace-nowrap"></div>
        </header>

        <!-- Loading -->
        <div id="loading" class="hidden p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i data-feather="package" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
            <p class="text-gray-500 mb-4" id="emptyMessage">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <button onclick="loadSections()" class="mt-4 py-2 px-4 bg-blue-500 text-white rounded-lg">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω—É—é
            </button>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden p-8 text-center">
            <i data-feather="alert-triangle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
            <p class="text-red-600 mb-4" id="errorMessage">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p>
            <button onclick="retryLastAction()" class="mt-4 py-2 px-4 bg-blue-500 text-white rounded-lg">
                –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>

        <!-- Main Content -->
        <main id="content" class="p-4">
            <div class="text-center py-8">
                <h2 class="text-xl font-bold mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥</h2>
                <button onclick="loadSections()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium">
                    –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥
                </button>
                <div class="mt-4 space-y-2">
                    <button onclick="loadBrigades()" class="w-full py-2 bg-green-500 text-white rounded-lg">
                        –ù–∞—à–∏ –±—Ä–∏–≥–∞–¥—ã
                    </button>
                    <button onclick="showChatList()" class="w-full py-2 bg-purple-500 text-white rounded-lg">
                        –ú–æ–∏ —á–∞—Ç—ã
                    </button>
                </div>
            </div>
        </main>

        <!-- –ß–∞—Ç -->
        <button class="chat-toggle" id="chatToggle" onclick="toggleChatWindow()">
            <i data-feather="message-circle"></i>
            <div class="chat-badge" id="chatBadge">0</div>
        </button>

        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <div>
                    <div class="font-semibold" id="chatTitle">–ß–∞—Ç —Å –±—Ä–∏–≥–∞–¥–æ–π</div>
                    <div class="text-sm opacity-90" id="chatSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <button onclick="toggleChatWindow()" class="text-white">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       onkeypress="handleChatInputKeypress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()">
                    <i data-feather="send"></i>
                </button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="chat-container" id="chatListContainer" style="display: none;">
            <div class="chat-header">
                <div>
                    <div class="font-semibold">–ú–æ–∏ —á–∞—Ç—ã</div>
                    <div class="text-sm opacity-90">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
                </div>
                <button onclick="toggleChatWindow()" class="text-white">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatSessionsList">
                <div class="text-center text-gray-500 p-4">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>
            </div>
        </div>
    </div>

    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const API_BASE = 'https://dmitrii2613.pythonanywhere.com/api';
        const CONTACT_INFO = {
            phone: "60-01-60",
            gisUrl: "https://2gis.ru/tyumen/firm/70000001048108193",
            telegramChannel: "https://t.me/skidkaservis",
            address: "–≥. –¢—é–º–µ–Ω—å, —É–ª. –ë–∞—Ä–∞–±–∏–Ω—Å–∫–∞—è 3–∞ —Å—Ç4"
        };

        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        let navigationStack = [];
        let currentProducts = [];
        let currentChatSession = null;
        let currentBrigadeChat = null;
        let currentObjectChat = null;
        let chatUpdateInterval = null;
        let isSendingMessage = false;
        let lastAction = null;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        // –≠–õ–ï–ú–ï–ù–¢–´ DOM
        const elements = {
            content: document.getElementById('content'),
            breadcrumbs: document.getElementById('breadcrumbs'),
            loading: document.getElementById('loading'),
            emptyState: document.getElementById('emptyState'),
            emptyMessage: document.getElementById('emptyMessage'),
            errorState: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            pageTitle: document.getElementById('pageTitle'),
            // –ß–∞—Ç —ç–ª–µ–º–µ–Ω—Ç—ã
            chatContainer: document.getElementById('chatContainer'),
            chatListContainer: document.getElementById('chatListContainer'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            chatTitle: document.getElementById('chatTitle'),
            chatSubtitle: document.getElementById('chatSubtitle'),
            chatBadge: document.getElementById('chatBadge'),
            chatSessionsList: document.getElementById('chatSessionsList'),
            chatToggle: document.getElementById('chatToggle')
        };

        // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï
        async function getUniversalStorage(key, defaultValue = null) {
            try {
                if (window.Telegram?.WebApp?.CloudStorage) {
                    return new Promise((resolve) => {
                        window.Telegram.WebApp.CloudStorage.getItem(key, (err, value) => {
                            resolve(value !== null ? JSON.parse(value) : defaultValue);
                        });
                    });
                }
                const item = localStorage.getItem(key);
                return item !== null ? JSON.parse(item) : defaultValue;
            } catch (error) {
                return defaultValue;
            }
        }

        async function setUniversalStorage(key, value) {
            try {
                if (window.Telegram?.WebApp?.CloudStorage) {
                    return new Promise((resolve) => {
                        window.Telegram.WebApp.CloudStorage.setItem(key, JSON.stringify(value), resolve);
                    });
                }
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error('Storage error:', error);
            }
        }

        // ========== –°–ò–°–¢–ï–ú–ê –ß–ê–¢–ê ==========

        function toggleChatWindow() {
            if (elements.chatContainer.style.display !== 'none') {
                closeChat();
            } else if (elements.chatListContainer.style.display !== 'none') {
                closeChatList();
            } else {
                showChatList();
            }
        }

        function showChatList() {
            closeAllChatWindows();
            elements.chatListContainer.style.display = 'flex';
            elements.chatToggle.classList.add('visible');
            loadChatSessions();
        }

        function closeChatList() {
            elements.chatListContainer.style.display = 'none';
            elements.chatToggle.classList.remove('visible');
        }

        function closeChat() {
            elements.chatContainer.style.display = 'none';
            elements.chatToggle.classList.remove('visible');
            stopChatUpdates();
        }

        function closeAllChatWindows() {
            closeChat();
            closeChatList();
        }

        function startChatUpdates() {
            if (chatUpdateInterval) clearInterval(chatUpdateInterval);
            chatUpdateInterval = setInterval(() => {
                if (currentChatSession && !isSendingMessage) {
                    loadChatHistory(currentChatSession);
                }
            }, 5000);
        }

        function stopChatUpdates() {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }

        async function sendChatMessage() {
            if (isSendingMessage) return;
            
            const input = elements.chatInput;
            const message = input.value.trim();
            if (!message) return;

            isSendingMessage = true;
            input.disabled = true;

            // –°–û–ó–î–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï
            const messageId = 'msg_' + Date.now();
            const userInfo = await getUserInfo();
            
            const messageData = {
                id: messageId,
                user_id: userInfo.id,
                user_name: userInfo.name,
                message_text: message,
                message_type: 'user_to_brigade',
                timestamp: new Date().toISOString(),
                status: 'sending'
            };
            
            // –°–û–•–†–ê–ù–Ø–ï–ú –ò –ü–û–ö–ê–ó–´–í–ê–ï–ú
            saveMessageLocally(messageData);
            addMessageToUI(messageData);
            input.value = '';

            try {
                const response = await fetch(`${API_BASE}/chat/send_message`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userInfo.id,
                        user_name: userInfo.name,
                        brigade_name: currentBrigadeChat,
                        message_text: message,
                        object_name: currentObjectChat
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    updateMessageStatus(messageId, 'sent', data.message_id);
                    setTimeout(() => loadChatHistory(currentChatSession), 500);
                } else {
                    updateMessageStatus(messageId, 'error');
                }
                
            } catch (error) {
                updateMessageStatus(messageId, 'error');
            } finally {
                isSendingMessage = false;
                input.disabled = false;
                input.focus();
            }
        }

        function addMessageToUI(messageData) {
            const time = new Date(messageData.timestamp).toLocaleTimeString('ru-RU', {
                hour: '2-digit', minute: '2-digit'
            });
            
            const messageElement = document.createElement('div');
            messageElement.setAttribute('data-message-id', messageData.id);
            
            let statusIcon = '‚úì';
            if (messageData.status === 'sending') {
                messageElement.className = 'message-user message-sending';
                statusIcon = '‚è≥';
            } else if (messageData.status === 'error') {
                messageElement.className = 'message-user message-error';
                statusIcon = '‚ùå';
            } else {
                messageElement.className = messageData.is_user ? 'message-user' : 'message-brigade';
            }
            
            const messageContent = `
                <div class="flex items-end gap-2">
                    ${!messageData.is_user ? `
                        <div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs">
                            üë∑
                        </div>
                    ` : ''}
                    <div class="flex-1">
                        <div class="text-sm">${escapeHtml(messageData.message_text)}</div>
                        <div class="text-xs opacity-70 mt-1 flex justify-between items-center">
                            <span>${time}</span>
                            <span class="text-xs">${statusIcon} ${escapeHtml(messageData.user_name)}</span>
                        </div>
                    </div>
                    ${messageData.is_user ? `
                        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-xs">
                            üë§
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageElement.innerHTML = messageContent;
            elements.chatMessages.appendChild(messageElement);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function updateMessageStatus(messageId, status, serverMessageId = null) {
            const messageElement = elements.chatMessages.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            messageElement.classList.remove('message-sending', 'message-error');
            
            if (status === 'sent') {
                messageElement.setAttribute('data-server-id', serverMessageId);
                updateLocalMessageStatus(messageId, 'sent', serverMessageId);
            } else if (status === 'error') {
                messageElement.classList.add('message-error');
                updateLocalMessageStatus(messageId, 'error');
            }
        }

        // –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –°–û–û–ë–©–ï–ù–ò–ô
        function saveMessageLocally(message) {
            if (!currentChatSession) return;
            const key = `chat_${currentChatSession}`;
            const existing = JSON.parse(localStorage.getItem(key)) || [];
            
            const updated = existing.filter(m => m.id !== message.id);
            updated.push(message);
            
            localStorage.setItem(key, JSON.stringify(updated));
        }

        function updateLocalMessageStatus(messageId, status, serverMessageId = null) {
            if (!currentChatSession) return;
            const key = `chat_${currentChatSession}`;
            const existing = JSON.parse(localStorage.getItem(key)) || [];
            
            const updated = existing.map(msg => 
                msg.id === messageId ? { ...msg, status, server_id: serverMessageId } : msg
            );
            
            localStorage.setItem(key, JSON.stringify(updated));
        }

        function loadLocalMessages() {
            if (!currentChatSession) return [];
            const key = `chat_${currentChatSession}`;
            return JSON.parse(localStorage.getItem(key)) || [];
        }

        async function loadChatHistory(sessionId) {
            try {
                const localMessages = loadLocalMessages();
                renderMessages(localMessages);
                
                const response = await fetch(`${API_BASE}/chat/history/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const merged = mergeMessages(localMessages, data.messages);
                    renderMessages(merged);
                    saveMergedMessages(merged);
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
        }

        function renderMessages(messages) {
            elements.chatMessages.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                elements.chatMessages.innerHTML = '<div class="text-center text-gray-500">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }
            
            messages.forEach(message => {
                addMessageToUI(message);
            });
        }

        function mergeMessages(localMessages, serverMessages) {
            const merged = [...localMessages];
            
            serverMessages.forEach(serverMsg => {
                const exists = merged.some(localMsg => 
                    localMsg.server_id === serverMsg.id || localMsg.message_text === serverMsg.message_text
                );
                if (!exists) {
                    merged.push({
                        ...serverMsg,
                        server_id: serverMsg.id,
                        status: 'sent'
                    });
                }
            });
            
            return merged.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function saveMergedMessages(messages) {
            if (!currentChatSession) return;
            const key = `chat_${currentChatSession}`;
            localStorage.setItem(key, JSON.stringify(messages));
        }

        async function loadChatSessions() {
            try {
                const userId = await getUserId();
                const response = await fetch(`${API_BASE}/chat/sessions/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderChatSessions(data.sessions);
                    updateChatBadge(data.sessions);
                }
            } catch (error) {
                elements.chatSessionsList.innerHTML = '<div class="text-center text-gray-500 p-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</div>';
            }
        }

        function renderChatSessions(sessions) {
            if (!sessions || sessions.length === 0) {
                elements.chatSessionsList.innerHTML = `
                    <div class="text-center text-gray-500 p-4">
                        <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                        <div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            let html = '';
            sessions.forEach(session => {
                const hasUnread = session.unread_count > 0;
                html += `
                    <div class="p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50 ${hasUnread ? 'bg-blue-50' : ''}" 
                         onclick="openChatSession('${session.session_id}', '${escapeHtml(session.brigade_name)}', '${escapeHtml(session.object_name || '')}')">
                        <div class="font-semibold">${escapeHtml(session.brigade_name)}</div>
                        <div class="text-sm text-gray-600">${escapeHtml(session.object_name || '–û–±—â–∏–π —á–∞—Ç')}</div>
                        ${hasUnread ? `<div class="text-xs text-red-500 mt-1">${session.unread_count} –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</div>` : ''}
                    </div>
                `;
            });
            
            elements.chatSessionsList.innerHTML = html;
            feather.replace();
        }

        function openChatSession(sessionId, brigadeName, objectName) {
            currentChatSession = sessionId;
            currentBrigadeChat = brigadeName;
            currentObjectChat = objectName;
            
            setUniversalStorage('last_chat_session', sessionId);
            setUniversalStorage('last_brigade_chat', brigadeName);
            setUniversalStorage('last_object_chat', objectName);
            
            elements.chatTitle.textContent = `–ß–∞—Ç —Å ${brigadeName}`;
            elements.chatSubtitle.textContent = objectName || '–û–±—â–∏–π —á–∞—Ç';
            
            closeChatList();
            elements.chatContainer.style.display = 'flex';
            elements.chatToggle.classList.add('visible');
            
            loadChatHistory(sessionId);
            startChatUpdates();
        }

        function startChatWithBrigade(brigadeName, objectName = null) {
            const userId = getUserId();
            let sessionId = `chat_${userId}_${brigadeName.replace(/ /g, '_')}`;
            if (objectName) {
                sessionId += `_${objectName.replace(/ /g, '_')}`;
            }
            
            openChatSession(sessionId, brigadeName, objectName);
        }

        // ========== –û–°–ù–û–í–ù–û–ô –ö–ê–¢–ê–õ–û–ì ==========

        async function loadSections() {
            lastAction = { type: 'loadSections' };
            navigationStack = [];
            updateBreadcrumbs([{ name: '–ö–∞—Ç–∞–ª–æ–≥', action: 'loadSections' }]);
            elements.pageTitle.textContent = '–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤';
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/sections`);
                const data = await response.json();
                
                hideLoading();
                
                if (data?.error || !data?.sections) {
                    showEmptyState('–†–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                renderSections(data.sections);
                
            } catch (error) {
                hideLoading();
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤');
            }
        }

        function renderSections(sections) {
            let html = '<div class="space-y-3">';
            
            sections.forEach(section => {
                if (!section) return;
                
                html += `
                    <div class="category-card fade-in" onclick="loadCategories('${escapeHtml(section.id)}', '${escapeHtml(section.name).replace(/'/g, "\\'")}')">
                        <div class="p-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-lg">${escapeHtml(section.name)}</h3>
                                ${section.min_price ? `<span class="price-badge">–æ—Ç ${Math.round(section.min_price)} —Ä.</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            html += `
                <div class="category-card fade-in" onclick="loadBrigades()">
                    <div class="p-4">
                        <div class="flex items-center">
                            <i data-feather="users" class="w-5 h-5 mr-3 text-blue-500"></i>
                            <h3 class="font-semibold text-lg">–ù–∞—à–∏ –±—Ä–∏–≥–∞–¥—ã</h3>
                        </div>
                    </div>
                </div>

                <div class="category-card fade-in" onclick="showChatList()">
                    <div class="p-4">
                        <div class="flex items-center">
                            <i data-feather="message-circle" class="w-5 h-5 mr-3 text-green-500"></i>
                            <h3 class="font-semibold text-lg">–ú–æ–∏ —á–∞—Ç—ã</h3>
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            elements.content.innerHTML = html;
            feather.replace();
        }

        async function loadCategories(sectionId, sectionName) {
            lastAction = { type: 'loadCategories', sectionId, sectionName };
            navigationStack = [{ type: 'sections', id: sectionId, name: sectionName }];
            updateBreadcrumbsFromStack();
            elements.pageTitle.textContent = sectionName;
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/categories/${sectionId}`);
                const data = await response.json();
                
                hideLoading();
                
                if (data?.error || !data?.categories) {
                    showEmptyState('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                let html = '<div class="space-y-3">';
                data.categories.forEach(category => {
                    html += `
                        <div class="category-card fade-in" onclick="loadCategoryProducts('${sectionId}', '${sectionName.replace(/'/g, "\\'")}', '${category.id}', '${category.name.replace(/'/g, "\\'")}')">
                            <div class="p-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-semibold text-lg">${escapeHtml(category.name)}</h3>
                                    ${category.min_price ? `<span class="price-badge">–æ—Ç ${Math.round(category.min_price)} —Ä.</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                elements.content.innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
            }
        }

        async function loadCategoryProducts(sectionId, sectionName, categoryId, categoryName) {
            lastAction = { type: 'loadCategoryProducts', sectionId, sectionName, categoryId, categoryName };
            navigationStack = [
                { type: 'sections', id: sectionId, name: sectionName },
                { type: 'categories', id: categoryId, name: categoryName }
            ];
            updateBreadcrumbsFromStack();
            elements.pageTitle.textContent = categoryName;
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/products_by_category/${sectionId}/${categoryId}`);
                const data = await response.json();
                
                hideLoading();
                
                if (data?.error || !data?.products) {
                    showEmptyState('–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                currentProducts = data.products;
                renderProducts();
                
            } catch (error) {
                hideLoading();
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤');
            }
        }

        function renderProducts() {
            if (!currentProducts || currentProducts.length === 0) {
                showEmptyState('–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            let html = '<div class="product-list space-y-4">';
            
            html += `
                <div class="p-4 bg-white rounded-xl shadow-sm">
                    <h2 class="text-lg font-semibold">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${currentProducts.length}</h2>
                </div>
            `;

            currentProducts.forEach((product, index) => {
                if (!product) return;
                
                const price = product.price ? formatPriceForBadge(product.price) : '';
                
                html += `
                    <div class="product-card fade-in">
                        <div class="universal-image-container">
                            ${product.photo_url ? `
                                <img src="${extractPhotoFilenameFromUrl(product.photo_url)}" 
                                     alt="${escapeHtml(product.color || '')}"
                                     class="universal-image"
                                     onerror="handleImageError(this)"
                                     loading="lazy">
                            ` : `
                                <div class="universal-image-placeholder">
                                    <i data-feather="package" class="w-12 h-12 text-gray-400"></i>
                                </div>
                            `}
                        </div>
                        
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-semibold text-lg">${escapeHtml(product.color || '–¢–æ–≤–∞—Ä')}</h3>
                                ${price ? `<span class="price-badge">${price}</span>` : ''}
                            </div>
                            
                            ${product.description ? `
                                <p class="text-gray-600 mb-4">${escapeHtml(product.description)}</p>
                            ` : ''}
                            
                            <div class="action-buttons">
                                <button onclick="makePhoneCall()" class="action-button phone-button">
                                    <i data-feather="phone" class="w-4 h-4"></i>
                                    ${CONTACT_INFO.phone}
                                </button>
                                <button onclick="contactAboutProduct(${index})" class="action-button share-button">
                                    <i data-feather="message-circle" class="w-4 h-4"></i>
                                    –£–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                <button onclick="goBack()" class="back-button">
                    <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>
                    –ù–∞–∑–∞–¥
                </button>
            `;

            html += '</div>';
            
            elements.content.innerHTML = html;
            feather.replace();
        }

        // ========== –ë–†–ò–ì–ê–î–´ ==========

        async function loadBrigades() {
            lastAction = { type: 'loadBrigades' };
            navigationStack = [];
            updateBreadcrumbs([{ name: '–ë—Ä–∏–≥–∞–¥—ã', action: 'loadBrigades' }]);
            elements.pageTitle.textContent = '–ù–∞—à–∏ –±—Ä–∏–≥–∞–¥—ã';
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/brigades`);
                const data = await response.json();
                
                hideLoading();
                
                if (data?.error || !data?.brigades) {
                    showEmptyState('–ë—Ä–∏–≥–∞–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                renderBrigades(data.brigades);
                
            } catch (error) {
                hideLoading();
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∏–≥–∞–¥');
            }
        }

        function renderBrigades(brigadeGroups) {
            let html = '<div class="space-y-6">';
            
            brigadeGroups.forEach(group => {
                if (!group.group_name || !group.brigades) return;
                
                html += `
                    <div>
                        <h2 class="text-xl font-bold mb-3">${escapeHtml(group.group_name)}</h2>
                        <div class="grid grid-cols-2 gap-3">
                `;
                
                group.brigades.forEach(brigade => {
                    const objectCount = brigade.objects ? brigade.objects.length : 0;
                    
                    html += `
                        <div class="bg-white rounded-lg p-3 shadow cursor-pointer" 
                             onclick="startChatWithBrigade('${escapeHtml(brigade.brigade_name)}')">
                            <h3 class="font-semibold">${escapeHtml(brigade.brigade_name)}</h3>
                            <p class="text-sm text-gray-600">${objectCount} –æ–±—ä–µ–∫—Ç–æ–≤</p>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            html += `
                <button onclick="loadSections()" class="back-button">
                    <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>
                    –ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥
                </button>
            </div>
            `;
            
            elements.content.innerHTML = html;
            feather.replace();
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function extractPhotoFilenameFromUrl(url) {
            if (!url || typeof url !== 'string') return null;
            url = url.trim();
            
            if (url.includes('drive.google.com')) {
                let fileId = null;
                if (url.includes('/file/d/')) {
                    const match = url.match(/\/file\/d\/([^\/]+)/);
                    fileId = match ? match[1] : null;
                } else if (url.includes('id=')) {
                    fileId = url.split('id=')[1].split('&')[0];
                }
                if (fileId) {
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }
            
            return url.startsWith('http') ? url : null;
        }

        function handleImageError(imgElement) {
            imgElement.style.display = 'none';
            const placeholder = document.createElement('div');
            placeholder.className = 'universal-image-placeholder';
            placeholder.innerHTML = '<i data-feather="package" class="w-12 h-12 text-gray-400"></i>';
            imgElement.parentElement.appendChild(placeholder);
            feather.replace();
        }

        function formatPriceForBadge(priceStr) {
            if (!priceStr) return '';
            const numeric = extractNumericPrice(priceStr);
            return numeric !== Infinity ? `${Math.round(numeric)} —Ä.` : '';
        }

        function extractNumericPrice(priceStr) {
            if (!priceStr || typeof priceStr !== 'string') return Infinity;
            try {
                let cleanStr = priceStr.replace(/[^\d,.]/g, '').replace(',', '.');
                const result = parseFloat(cleanStr);
                return isNaN(result) ? Infinity : result;
            } catch {
                return Infinity;
            }
        }

        async function getUserInfo() {
            let userId = await getUniversalStorage('user_id');
            let userName = await getUniversalStorage('user_name');
            
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                await setUniversalStorage('user_id', userId);
            }
            
            if (!userName) {
                if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                    userName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                } else {
                    userName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }
                await setUniversalStorage('user_name', userName);
            }
            
            return { id: userId, name: userName };
        }

        async function getUserId() {
            const userInfo = await getUserInfo();
            return userInfo.id;
        }

        function handleChatInputKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function updateChatBadge(sessions) {
            if (!sessions || sessions.length === 0) {
                elements.chatBadge.style.display = 'none';
                return;
            }
            
            const totalUnread = sessions.reduce((sum, session) => sum + (session.unread_count || 0), 0);
            
            if (totalUnread > 0) {
                elements.chatBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                elements.chatBadge.style.display = 'flex';
            } else {
                elements.chatBadge.style.display = 'none';
            }
        }

        function updateBreadcrumbsFromStack() {
            const items = [{ name: '–ö–∞—Ç–∞–ª–æ–≥', action: 'loadSections' }];
            navigationStack.forEach(item => {
                if (item && item.name) {
                    items.push({ name: item.name, action: null });
                }
            });
            updateBreadcrumbs(items);
        }

        function updateBreadcrumbs(items) {
            elements.breadcrumbs.innerHTML = '';
            items.forEach((item, index) => {
                if (!item || !item.name) return;
                
                const crumb = document.createElement('span');
                crumb.className = 'flex items-center whitespace-nowrap';
                
                if (index > 0) {
                    const separator = document.createElement('span');
                    separator.className = 'mx-1 text-gray-500';
                    separator.innerHTML = '<i data-feather="chevron-right" class="w-3 h-3"></i>';
                    elements.breadcrumbs.appendChild(separator);
                }
                
                const link = document.createElement('span');
                link.className = 'text-sm truncate max-w-[120px]';
                link.textContent = item.name;
                
                if (item.action && index === 0) {
                    link.style.cursor = 'pointer';
                    link.onclick = () => loadSections();
                }
                
                crumb.appendChild(link);
                elements.breadcrumbs.appendChild(crumb);
            });
            feather.replace();
        }

        function showLoading() {
            elements.loading.classList.remove('hidden');
            elements.content.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
        }

        function hideLoading() {
            elements.loading.classList.add('hidden');
            elements.content.classList.remove('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
        }

        function showEmptyState(message = '–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') {
            elements.content.classList.add('hidden');
            elements.loading.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyMessage.textContent = message;
        }

        function showError(message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞') {
            elements.content.classList.add('hidden');
            elements.loading.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorState.classList.remove('hidden');
            elements.errorMessage.textContent = message;
        }

        function goBack() {
            if (navigationStack.length > 0) {
                navigationStack.pop();
                if (navigationStack.length === 0) {
                    loadSections();
                } else {
                    const previousItem = navigationStack[navigationStack.length - 1];
                    if (previousItem.type === 'sections') {
                        loadSections();
                    } else if (previousItem.type === 'categories') {
                        loadCategories(previousItem.id, previousItem.name);
                    }
                }
            } else {
                loadSections();
            }
        }

        function retryLastAction() {
            if (!lastAction) {
                loadSections();
                return;
            }
            switch (lastAction.type) {
                case 'loadSections': loadSections(); break;
                case 'loadCategories': loadCategories(lastAction.sectionId, lastAction.sectionName); break;
                case 'loadCategoryProducts': loadCategoryProducts(lastAction.sectionId, lastAction.sectionName, lastAction.categoryId, lastAction.categoryName); break;
                case 'loadBrigades': loadBrigades(); break;
                default: loadSections();
            }
        }

        function makePhoneCall() {
            alert(`–¢–µ–ª–µ—Ñ–æ–Ω: ${CONTACT_INFO.phone}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º!`);
        }

        function contactAboutProduct(productIndex) {
            const product = currentProducts[productIndex];
            const message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–æ–≤–∞—Ä: ${product.color}. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.`;
            window.open(`https://t.me/SkidkaService01?text=${encodeURIComponent(message)}`, '_blank');
        }

        function openSideMenu() {
            alert('–ú–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ - –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞–∑–¥–µ–ª—ã –∫–∞—Ç–∞–ª–æ–≥–∞, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
        }

        function installPWA() {
            alert('–§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA');
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                feather.replace();
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
                const lastSessionId = await getUniversalStorage('last_chat_session');
                const lastBrigade = await getUniversalStorage('last_brigade_chat');
                
                if (lastSessionId && lastBrigade) {
                    currentChatSession = lastSessionId;
                    currentBrigadeChat = lastBrigade;
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞
                setInterval(updateChatBadgeFromServer, 30000);
                updateChatBadgeFromServer();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        });

        async function updateChatBadgeFromServer() {
            try {
                const userId = await getUserId();
                const response = await fetch(`${API_BASE}/chat/sessions/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    updateChatBadge(data.sessions);
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            }
        }

        // –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô
        window.toggleChatWindow = toggleChatWindow;
        window.showChatList = showChatList;
        window.startChatWithBrigade = startChatWithBrigade;
        window.sendChatMessage = sendChatMessage;
        window.handleChatInputKeypress = handleChatInputKeypress;
        window.openChatSession = openChatSession;
        window.loadSections = loadSections;
        window.loadBrigades = loadBrigades;
        window.loadCategories = loadCategories;
        window.loadCategoryProducts = loadCategoryProducts;
        window.makePhoneCall = makePhoneCall;
        window.contactAboutProduct = contactAboutProduct;
        window.openSideMenu = openSideMenu;
        window.installPWA = installPWA;
        window.goBack = goBack;
        window.retryLastAction = retryLastAction;
    </script>
</body>
</html>
